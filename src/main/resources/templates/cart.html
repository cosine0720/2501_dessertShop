<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>購物車</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/minty/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            padding-top: 56px;
            padding-bottom: 10px;
        }
        .d-flex {
            display: flex;
        }
        .flex-column {
            flex-direction: column;
        }
        .flex-fill {
            flex: 1 0 auto; /* 填滿剩餘空間 */
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <div th:replace="common.html :: navbar"></div>

    <main class="flex-fill">
        <div class="container mt-5">
            <h2>購物車</h2>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>商品</th>
                            <th>單價</th>
                            <th>數量</th>
                            <th>小計</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${cartItems}">
                            <td th:text="${item.product.name}"></td>
                            <td th:text="${'NT$ ' + item.product.price}"></td>
                            <td>
                                <input type="number" th:value="${item.quantity}"
                                       th:data-id="${item.id}" class="form-control quantity-input"
                                       min="1" style="width: 80px;">
                            </td>
                            <td th:text="${'NT$ ' + item.product.price.multiply(new java.math.BigDecimal(item.quantity))}"></td>
                            <td>
                                <button class="btn btn-danger btn-sm remove-item"
                                        th:data-id="${item.id}">刪除</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="text-end mt-3">
                <a href="/checkout" class="btn btn-primary">結帳</a>
            </div>
        </div>
    </main>

    <div th:replace="common.html :: footer"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.quantity-input').change(function() {
                const id = $(this).data('id');
                const quantity = $(this).val();
                $.post('/cart/update', { cartItemId: id, quantity: quantity })
                    .fail(function() {
                        alert('更新數量失敗，請稍後再試');
                    });

            $('.remove-item').click(function() {
                const id = $(this).data('id');
                $.post('/cart/remove', {
                    cartItemId: id
                }).done(function() {
                    location.reload();
                }).fail(function() {
                    alert('刪除失敗，請稍後再試');
                });
            });
        });
    </script>
</body>
</html> 